<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 500px; /* Width of the popup */
            height: 700px; /* Height of the popup */
            display: flex;
            flex-direction: column;
        }
        iframe {
            flex-grow: 1;
            border: none;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-family: sans-serif;
            font-size: 16px;
            color: #555;
        }
    </style>
</head>
<body>
    <!-- A loading message while we get the tab info -->
    <div id="loading" class="loading">Loading...</div>
    
    <!-- The Sharelette app will be loaded into this iframe -->
    <iframe id="sharelette-frame" style="display:none;"></iframe>

    <script>
    // This script runs when the popup is opened.
    document.addEventListener('DOMContentLoaded', () => {
        // Query for the currently active tab in the browser.
        chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
            const loadingDiv = document.getElementById('loading');
            const iframe = document.getElementById('sharelette-frame');

            // Ensure we got a tab back.
            if (tabs.length === 0) {
                loadingDiv.textContent = 'Could not find an active tab.';
                return;
            }

            const tab = tabs[0];
            const url = tab.url;
            const title = tab.title;

            // Check if the URL is a shareable web page.
            if (!url || !url.startsWith('http')) {
                loadingDiv.textContent = 'This page cannot be shared.';
                return;
            }

            // Construct the Sharelette URL with the page's data.
            const shareletteBaseUrl = 'https://sharelette.cloudbreak.app';
            const shareUrl = new URL(shareletteBaseUrl);
            shareUrl.searchParams.set('url', url);
            shareUrl.searchParams.set('text', title);

            // Set the iframe's source and make it visible.
            iframe.src = shareUrl.toString();
            iframe.style.display = 'block';
            loadingDiv.style.display = 'none';
        });
    });
    </script>
</body>
</html>
